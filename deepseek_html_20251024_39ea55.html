<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Viabilidad de Terreno</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #27ae60;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .calculator-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .calculator-container {
                grid-template-columns: 1fr;
            }
        }
        
        .input-section, .results-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-export {
            background-color: var(--success-color);
            margin-left: 10px;
        }
        
        .btn-export:hover {
            background-color: #219653;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .result-item {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .result-label {
            font-size: 0.9rem;
            color: var(--dark-color);
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .dashboard {
            margin-top: 30px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        
        .summary-section {
            margin-top: 30px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }
        
        .summary-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .actions {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .highlight {
            color: var(--accent-color);
            font-weight: 700;
        }
        
        .positive {
            color: var(--success-color);
        }
        
        .negative {
            color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Calculadora de Viabilidad de Terreno</h1>
            <p class="subtitle">Análisis completo de proyectos inmobiliarios</p>
        </header>
        
        <div class="calculator-container">
            <div class="input-section">
                <h2 class="section-title">Datos del Proyecto</h2>
                
                <div class="form-group">
                    <label for="tc">TC (Tipo de Cambio):</label>
                    <input type="number" id="tc" step="0.01" value="3.5">
                </div>
                
                <div class="form-group">
                    <label for="distrito">Distrito:</label>
                    <input type="text" id="distrito" value="Jesus Maria">
                </div>
                
                <div class="form-group">
                    <label for="direccion">Dirección:</label>
                    <input type="text" id="direccion" value="Miller">
                </div>
                
                <div class="form-group">
                    <label for="area-terreno">Área de terreno (m²):</label>
                    <input type="number" id="area-terreno" value="1000">
                </div>
                
                <div class="form-group">
                    <label for="precio-m2">Precio US$ x m²:</label>
                    <input type="number" id="precio-m2" value="3500">
                </div>
                
                <div class="form-group">
                    <label for="altura">Altura (pisos):</label>
                    <input type="number" id="altura" value="17">
                </div>
                
                <div class="form-group">
                    <label for="area-comercio">Área comercio (m²):</label>
                    <input type="number" id="area-comercio" value="150">
                </div>
                
                <div class="form-group">
                    <label for="estacionamientos">Nº estacionamientos primer piso:</label>
                    <input type="number" id="estacionamientos" value="15">
                </div>
                
                <div class="form-group">
                    <label for="precio-deptos">Precio m² deptos (S/):</label>
                    <input type="number" id="precio-deptos" value="7200">
                </div>
                
                <div class="form-group">
                    <label for="velocidad-ventas">Velocidad de ventas (dptos/mes):</label>
                    <input type="number" id="velocidad-ventas" value="3">
                </div>
                
                <div class="form-group">
                    <label for="arquitectura">Arquitectura (S/ x m²):</label>
                    <input type="number" id="arquitectura" value="700">
                </div>
                
                <button id="calcular-btn" class="btn">Calcular Viabilidad</button>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Resultados Financieros</h2>
                
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">Valor del Terreno US$</div>
                        <div class="result-value" id="valor-terreno-usd">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Valor del Terreno S/</div>
                        <div class="result-value" id="valor-terreno-sol">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Incidencia del terreno</div>
                        <div class="result-value" id="incidencia-terreno">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Ventas totales S/</div>
                        <div class="result-value" id="ventas-totales">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Inversión S/</div>
                        <div class="result-value" id="inversion">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Utilidad neta S/</div>
                        <div class="result-value" id="utilidad-neta">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Aporte S/</div>
                        <div class="result-value" id="aporte">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Preventa S/</div>
                        <div class="result-value" id="preventa">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Financiamiento S/</div>
                        <div class="result-value" id="financiamiento">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Margen neto %</div>
                        <div class="result-value" id="margen-neto">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">ROI</div>
                        <div class="result-value" id="roi">-</div>
                    </div>
                </div>
                
                <h3 class="section-title" style="margin-top: 20px;">Unidades</h3>
                
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">Unidades Dptos edificio</div>
                        <div class="result-value" id="unidades-dptos">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Unidades Estacionamientos</div>
                        <div class="result-value" id="unidades-estacionamientos">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Área vendible m²</div>
                        <div class="result-value" id="area-vendible">-</div>
                    </div>
                </div>
                
                <h3 class="section-title" style="margin-top: 20px;">Tiempos</h3>
                
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">Meses de obra</div>
                        <div class="result-value" id="meses-obra">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Meses de preventa</div>
                        <div class="result-value" id="meses-preventa">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Meses de venta total</div>
                        <div class="result-value" id="meses-venta-total">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <h2 class="section-title">Dashboard de Resultados</h2>
            
            <div class="charts-container">
                <div class="chart-container">
                    <canvas id="ingresosChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="costosChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="financiamientoChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="utilidadChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="summary-section">
            <h2 class="section-title">Resumen de Viabilidad</h2>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Ventas Totales</h3>
                    <div class="summary-value" id="summary-ventas">-</div>
                </div>
                
                <div class="summary-card">
                    <h3>Inversión Total</h3>
                    <div class="summary-value" id="summary-inversion">-</div>
                </div>
                
                <div class="summary-card">
                    <h3>Utilidad Neta</h3>
                    <div class="summary-value positive" id="summary-utilidad">-</div>
                </div>
                
                <div class="summary-card">
                    <h3>ROI</h3>
                    <div class="summary-value positive" id="summary-roi">-</div>
                </div>
            </div>
            
            <div class="actions">
                <button id="export-pdf" class="btn btn-export">Exportar a PDF</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para los gráficos
        let ingresosChart, costosChart, financiamientoChart, utilidadChart;
        
        // Función para formatear números con separadores de miles
        function formatNumber(num) {
            return new Intl.NumberFormat('es-PE').format(num);
        }
        
        // Función para calcular todos los valores
        function calcularViabilidad() {
            // Obtener valores de los inputs
            const tc = parseFloat(document.getElementById('tc').value);
            const distrito = document.getElementById('distrito').value;
            const direccion = document.getElementById('direccion').value;
            const areaTerreno = parseFloat(document.getElementById('area-terreno').value);
            const precioM2 = parseFloat(document.getElementById('precio-m2').value);
            const altura = parseInt(document.getElementById('altura').value);
            const areaComercio = parseFloat(document.getElementById('area-comercio').value);
            const estacionamientos = parseInt(document.getElementById('estacionamientos').value);
            const precioDeptos = parseFloat(document.getElementById('precio-deptos').value);
            const velocidadVentas = parseInt(document.getElementById('velocidad-ventas').value);
            const arquitectura = parseFloat(document.getElementById('arquitectura').value);
            
            // Cálculos principales basados en las fórmulas del Excel
            const valorTerrenoUSD = areaTerreno * precioM2;
            const valorTerrenoSOL = valorTerrenoUSD * tc;
            
            // Cálculo de áreas
            const areaVendible = ((areaTerreno * 0.68) * 0.87 * altura) - (areaTerreno / 4) + (0.1 * areaTerreno);
            const areaSotano = ((estacionamientos * 0.45 - estacionamientos) * 45) + 100;
            const areaEdificio = ((areaTerreno * 0.67) * altura) + (0.28 * areaTerreno);
            const areaConstruida = areaVendible + areaSotano;
            
            // Cálculo de unidades
            const unidadesDptos = Math.floor(areaVendible / 60);
            const unidadesEstacionamientos = Math.floor(estacionamientos * 0.45) + estacionamientos;
            
            // Cálculo de ingresos
            const ingresoDeptos = (areaVendible - areaComercio) * precioDeptos;
            const ingresoComercio = areaComercio * 10000;
            const ingresoEstacionamientos = unidadesEstacionamientos * 50000;
            const ingresoTerrazas = ingresoDeptos * 0.01;
            const ingresoTotalSOL = ingresoDeptos + ingresoComercio + ingresoEstacionamientos + ingresoTerrazas;
            const ingresoTotalUSD = ingresoTotalSOL / tc;
            
            // Cálculo de incidencia del terreno
            const comisionTerreno = (valorTerrenoUSD * tc * 0.03) * 1.18;
            const alcabala = (valorTerrenoUSD * tc * 0.03);
            const notariales = ingresoTotalSOL * 0.0012;
            const incidenciaTerreno = ((valorTerrenoSOL + comisionTerreno + alcabala + notariales) / ingresoTotalSOL) * 100;
            
            // Cálculo de tiempos
            const mesesPreventa = Math.ceil((unidadesDptos * 0.3) / velocidadVentas);
            const mesesObra = Math.ceil(altura / 3.7) + 6 + 1 + 1; // Aproximación basada en fórmulas del Excel
            const mesesVentaStock = Math.ceil((unidadesDptos * 0.1) / velocidadVentas);
            const mesesVentaTotal = mesesPreventa + 1 + mesesObra + mesesVentaStock;
            
            // Cálculo de costos de obra (simplificado)
            const costoObraSinIGV = areaConstruida * 2000; // Valor aproximado
            const costoObraConIGV = costoObraSinIGV * 1.18;
            
            // Cálculo de compras directas
            const comprasDirectasSinIGV = (unidadesDptos / 30 * 50000 * tc) + (500 * unidadesDptos) + (1500 * unidadesDptos) + (30 * areaConstruida);
            const comprasDirectasConIGV = comprasDirectasSinIGV * 1.18;
            
            // Cálculo de supervisión
            const supervisionSinIGV = 25000 * mesesObra;
            const supervisionConIGV = supervisionSinIGV * 1.18;
            
            // Cálculo de inversión total
            const inversionTotal = valorTerrenoSOL + comisionTerreno + alcabala + notariales + 
                                 (ingresoTotalSOL * 0.0012) + (ingresoTotalSOL * 0.017) + 
                                 (ingresoTotalSOL * 0.0025) + (ingresoTotalSOL * 0.0045) + 
                                 costoObraConIGV + comprasDirectasConIGV + supervisionConIGV +
                                 (ingresoTotalSOL * 0.0035) + (ingresoTotalSOL * 0.0132) +
                                 (ingresoTotalSOL * 0.0034) + (ingresoTotalSOL * 0.0084) +
                                 (ingresoTotalSOL * 0.0205) + (ingresoTotalSOL * 0.0095) +
                                 (ingresoTotalSOL * 0.02) + (ingresoTotalSOL * 0.008) +
                                 (ingresoTotalSOL * 0.054) + (ingresoTotalSOL * 0.0032) +
                                 (ingresoTotalSOL * 0.0142) + (ingresoTotalSOL * 0.005) +
                                 (ingresoTotalSOL * 0.0002) + (ingresoTotalSOL * 0.003) +
                                 (ingresoTotalSOL * 0) + (ingresoTotalSOL * 0.0015) +
                                 ((valorTerrenoSOL * 0.6) * (Math.pow(1.095, 1) - 1));
            
            // Cálculo de financiamiento
            const aporte = inversionTotal * 0.22;
            const preventa = inversionTotal * 0.3;
            const financiamiento = inversionTotal * 0.48;
            
            // Cálculo de utilidad
            const utilidadNeta = ingresoTotalSOL - inversionTotal;
            const margenNeto = (utilidadNeta / ingresoTotalSOL) * 100;
            const roi = (utilidadNeta / aporte) * 100;
            
            // Actualizar la interfaz con los resultados
            document.getElementById('valor-terreno-usd').textContent = `US$ ${formatNumber(Math.round(valorTerrenoUSD))}`;
            document.getElementById('valor-terreno-sol').textContent = `S/ ${formatNumber(Math.round(valorTerrenoSOL))}`;
            document.getElementById('incidencia-terreno').textContent = `${incidenciaTerreno.toFixed(1)}%`;
            document.getElementById('ventas-totales').textContent = `S/ ${formatNumber(Math.round(ingresoTotalSOL))}`;
            document.getElementById('inversion').textContent = `S/ ${formatNumber(Math.round(inversionTotal))}`;
            document.getElementById('utilidad-neta').textContent = `S/ ${formatNumber(Math.round(utilidadNeta))}`;
            document.getElementById('aporte').textContent = `S/ ${formatNumber(Math.round(aporte))}`;
            document.getElementById('preventa').textContent = `S/ ${formatNumber(Math.round(preventa))}`;
            document.getElementById('financiamiento').textContent = `S/ ${formatNumber(Math.round(financiamiento))}`;
            document.getElementById('margen-neto').textContent = `${margenNeto.toFixed(1)}%`;
            document.getElementById('roi').textContent = `${roi.toFixed(1)}%`;
            
            document.getElementById('unidades-dptos').textContent = unidadesDptos;
            document.getElementById('unidades-estacionamientos').textContent = unidadesEstacionamientos;
            document.getElementById('area-vendible').textContent = `${formatNumber(Math.round(areaVendible))} m²`;
            
            document.getElementById('meses-obra').textContent = mesesObra;
            document.getElementById('meses-preventa').textContent = mesesPreventa;
            document.getElementById('meses-venta-total').textContent = mesesVentaTotal;
            
            // Actualizar resumen
            document.getElementById('summary-ventas').textContent = `S/ ${formatNumber(Math.round(ingresoTotalSOL))}`;
            document.getElementById('summary-inversion').textContent = `S/ ${formatNumber(Math.round(inversionTotal))}`;
            document.getElementById('summary-utilidad').textContent = `S/ ${formatNumber(Math.round(utilidadNeta))}`;
            document.getElementById('summary-roi').textContent = `${roi.toFixed(1)}%`;
            
            // Actualizar gráficos
            actualizarGraficos(ingresoTotalSOL, utilidadNeta, inversionTotal, aporte, preventa, financiamiento);
        }
        
        // Función para actualizar los gráficos
        function actualizarGraficos(ingresos, utilidad, inversion, aporte, preventa, financiamiento) {
            // Destruir gráficos existentes si existen
            if (ingresosChart) ingresosChart.destroy();
            if (costosChart) costosChart.destroy();
            if (financiamientoChart) financiamientoChart.destroy();
            if (utilidadChart) utilidadChart.destroy();
            
            // Gráfico de ingresos vs inversión
            const ingresosCtx = document.getElementById('ingresosChart').getContext('2d');
            ingresosChart = new Chart(ingresosCtx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Inversión'],
                    datasets: [{
                        label: 'Monto (S/)',
                        data: [ingresos, inversion],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'rgba(46, 204, 113, 1)',
                            'rgba(231, 76, 60, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ingresos vs Inversión'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de estructura de financiamiento
            const financiamientoCtx = document.getElementById('financiamientoChart').getContext('2d');
            financiamientoChart = new Chart(financiamientoCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Aporte', 'Preventa', 'Financiamiento'],
                    datasets: [{
                        data: [aporte, preventa, financiamiento],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(241, 196, 15, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Estructura de Financiamiento'
                        }
                    }
                }
            });
            
            // Gráfico de utilidad
            const utilidadCtx = document.getElementById('utilidadChart').getContext('2d');
            utilidadChart = new Chart(utilidadCtx, {
                type: 'bar',
                data: {
                    labels: ['Utilidad Neta'],
                    datasets: [{
                        label: 'Monto (S/)',
                        data: [utilidad],
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Utilidad Neta del Proyecto'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de costos
            const costosCtx = document.getElementById('costosChart').getContext('2d');
            costosChart = new Chart(costosCtx, {
                type: 'pie',
                data: {
                    labels: ['Terreno', 'Obra', 'Compras Directas', 'Gastos Varios'],
                    datasets: [{
                        data: [
                            document.getElementById('valor-terreno-sol').textContent.replace(/[^\d]/g, ''),
                            inversion * 0.4, // Aproximación
                            inversion * 0.2, // Aproximación
                            inversion * 0.2  // Aproximación
                        ],
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(46, 204, 113, 0.7)'
                        ],
                        borderColor: [
                            'rgba(231, 76, 60, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(241, 196, 15, 1)',
                            'rgba(46, 204, 113, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribución de Costos'
                        }
                    }
                }
            });
        }
        
        // Función para exportar a PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Título
            doc.setFontSize(20);
            doc.text('Calculadora de Viabilidad de Terreno', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Análisis completo de proyectos inmobiliarios', 105, 22, { align: 'center' });
            
            // Información del proyecto
            doc.setFontSize(14);
            doc.text('Datos del Proyecto', 20, 35);
            doc.setFontSize(10);
            
            const distrito = document.getElementById('distrito').value;
            const direccion = document.getElementById('direccion').value;
            const areaTerreno = document.getElementById('area-terreno').value;
            const precioM2 = document.getElementById('precio-m2').value;
            const altura = document.getElementById('altura').value;
            const precioDeptos = document.getElementById('precio-deptos').value;
            const velocidadVentas = document.getElementById('velocidad-ventas').value;
            
            doc.text(`Distrito: ${distrito}`, 20, 45);
            doc.text(`Dirección: ${direccion}`, 20, 52);
            doc.text(`Área m² Terreno: ${formatNumber(areaTerreno)}`, 20, 59);
            doc.text(`Precio US$ x m² (Terreno): ${formatNumber(precioM2)}`, 20, 66);
            doc.text(`N° pisos edificio: ${altura}`, 20, 73);
            doc.text(`Precio m² de deptos: S/ ${formatNumber(precioDeptos)}`, 20, 80);
            doc.text(`Velocidad de ventas: ${velocidadVentas} dptos/mes`, 20, 87);
            
            // Resultados financieros
            doc.setFontSize(14);
            doc.text('Resultados Financieros', 20, 105);
            doc.setFontSize(10);
            
            const valorTerrenoUSD = document.getElementById('valor-terreno-usd').textContent;
            const valorTerrenoSOL = document.getElementById('valor-terreno-sol').textContent;
            const incidenciaTerreno = document.getElementById('incidencia-terreno').textContent;
            const ventasTotales = document.getElementById('ventas-totales').textContent;
            const inversion = document.getElementById('inversion').textContent;
            const utilidadNeta = document.getElementById('utilidad-neta').textContent;
            const aporte = document.getElementById('aporte').textContent;
            const preventa = document.getElementById('preventa').textContent;
            const financiamiento = document.getElementById('financiamiento').textContent;
            const margenNeto = document.getElementById('margen-neto').textContent;
            const roi = document.getElementById('roi').textContent;
            
            doc.text(`Valor del Terreno US$: ${valorTerrenoUSD}`, 20, 115);
            doc.text(`Valor del Terreno S/: ${valorTerrenoSOL}`, 20, 122);
            doc.text(`Incidencia del terreno: ${incidenciaTerreno}`, 20, 129);
            doc.text(`Ventas totales S/: ${ventasTotales}`, 20, 136);
            doc.text(`Inversión S/: ${inversion}`, 20, 143);
            doc.text(`Utilidad neta S/: ${utilidadNeta}`, 20, 150);
            doc.text(`Aporte S/: ${aporte}`, 20, 157);
            doc.text(`Preventa S/: ${preventa}`, 20, 164);
            doc.text(`Financiamiento S/: ${financiamiento}`, 20, 171);
            doc.text(`Margen neto: ${margenNeto}`, 20, 178);
            doc.text(`ROI: ${roi}`, 20, 185);
            
            // Unidades
            doc.setFontSize(14);
            doc.text('Unidades', 110, 105);
            doc.setFontSize(10);
            
            const unidadesDptos = document.getElementById('unidades-dptos').textContent;
            const unidadesEstacionamientos = document.getElementById('unidades-estacionamientos').textContent;
            const areaVendible = document.getElementById('area-vendible').textContent;
            
            doc.text(`Unidades Dptos edificio: ${unidadesDptos}`, 110, 115);
            doc.text(`Unidades Estacionamientos: ${unidadesEstacionamientos}`, 110, 122);
            doc.text(`Área vendible m²: ${areaVendible}`, 110, 129);
            
            // Tiempos
            doc.setFontSize(14);
            doc.text('Tiempos', 110, 145);
            doc.setFontSize(10);
            
            const mesesObra = document.getElementById('meses-obra').textContent;
            const mesesPreventa = document.getElementById('meses-preventa').textContent;
            const mesesVentaTotal = document.getElementById('meses-venta-total').textContent;
            
            doc.text(`Meses de obra: ${mesesObra}`, 110, 155);
            doc.text(`Meses de preventa: ${mesesPreventa}`, 110, 162);
            doc.text(`Meses de venta total: ${mesesVentaTotal}`, 110, 169);
            
            // Guardar el PDF
            doc.save('viabilidad-proyecto.pdf');
        }
        
        // Event Listeners
        document.getElementById('calcular-btn').addEventListener('click', calcularViabilidad);
        document.getElementById('export-pdf').addEventListener('click', exportToPDF);
        
        // Calcular al cargar la página
        window.addEventListener('DOMContentLoaded', calcularViabilidad);
    </script>
</body>
</html>